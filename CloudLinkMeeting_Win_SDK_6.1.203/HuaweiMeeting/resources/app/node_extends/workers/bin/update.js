var http=require("http"),fs=require("fs"),path=require("path"),electron=require("electron"),clear=require("./deepRemove"),createPath=require("./createPath"),getConfig=require("./config").getConfig,release_server_address=getConfig().RELEASE_SERVER_ADDRESS;function getJoinedVersion(){return httpGet(release_server_address+"/version",function(t,n,r){var o=[],s=16777216;t.on("data",function(e){if((s-=o.length)<0)return t.closeSync()|r("too large data!");o.push(e)}),t.on("end",function(){var e=Buffer.concat(o);n(e.toString())})})}function getVersionsObject(e){return httpGet(release_server_address+"/"+e,function(e,t,n){var r=[],o=16777216;e.on("data",function(e){if((o-=r.length)<0)return n("too large data!");r.push(e)}),e.on("end",function(){var e=Buffer.concat(r);t(JSON.parse(e.toString()))})})}function getPathList(e){var r=[],o=function(t,n){if(t instanceof Object)return Object.keys(t).map(function(e){o(t[e],n+"/"+encodeURIComponent(e))});r.push(n)};return o(e,""),r}function loadAllFilesByVersion(n,r){if(!r||!fs.existsSync(r))throw"%APPDATA% ISN'T CORRECT:"+r;return update(n).then(function(e){var t=getPathList(e);return update(n,t,r).then(function(){return e})})}function loadFilesByPathList(t,n,r){var o=0,f=module.exports.loadding={version:t,files_list:n,user_data_path:r},s=function(){if(o>=n.length)return Promise.resolve(path.join(r,t));var e=n[o],c=path.join(r,t,decodeURIComponent(e)),u=path.dirname(c);return console.log(c,u,fs.existsSync(u)),fs.existsSync(u)||createPath(u),console.log(c,u,fs.existsSync(u)),Object.assign(f,{filename:e,fullpath:c,file_index:o++}),console.log(c,u,fs.existsSync(u)),httpGet(release_server_address+"/"+t+"/"+e,function(e,t,n){f.content_length=+e.headers["Content-Length"];var r=[],o=0,s=0;clear(c),console.log(c,u,fs.existsSync(u));var a=fs.openSync(c,"w"),i=function(){fs.writeSync(a,Buffer.concat(r),0,o,s),s+=o,o=0,r=[]};e.on("data",function(e){o+=e.length,r.push(e),f.loaded_size=o+s,f.flushed_size=o+s,67108864<o&&i()}),e.on("end",function(){i(),fs.closeSync(a),t(s)}),e.on("close",function(){fs.closeSync(a)})}).then(s)};return s()}function loadFilesByPathObject(e,t,n){return update(e,getPathList(t),n)}function httpGet(r,o){return new Promise(function(t,n){http.get(r,function(e){switch(e.statusCode){case 200:o(e,t,n);break;case 404:n("not found!");break;case 403:n("forbidden!");break;default:n("status code:"+e.statusCode+", url:"+r)}}).on("error",function(e){console.error("connection is not success! url:"+r),n(e)})})}function loadFileByPath(e,t){return httpGet(release_server_address+"/"+e+"/"+t,function(e,t,n){var r=[],o=16777216;e.on("data",function(e){if((o-=r.length)<0)return n("too large data!");r.push(e)}),e.on("end",function(){var e=Buffer.concat(r);t(e)})})}function update(e,t,n){return release_server_address=getConfig().RELEASE_SERVER_ADDRESS,e?t?!0===t?loadAllFilesByVersion(e,n):t instanceof Array?loadFilesByPathList(e,t,n):t instanceof Object?loadFilesByPathObject(e,t,n):loadFileByPath(e,t):getVersionsObject(e):getJoinedVersion()}module.exports=update;